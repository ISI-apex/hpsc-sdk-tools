#!/usr/bin/env python3

import sys
import os
import re
import argparse
import configparser

parser = argparse.ArgumentParser(
    description="Compose a Simple File System image from files defined in memory map")
parser.add_argument('map_file',
    help='Input file with memory map')
parser.add_argument('--config', '-c', required=True,
    help='Input file with size and other parameters in INI format')
parser.add_argument('--tool', '-t', required=True,
    help='Command for invoking the underlying tool')
parser.add_argument('--output', '-o', required=True,
    help='Output filename where to save the binary image')
args = parser.parse_args()

cfg = configparser.ConfigParser()
cfg.read(args.config)

size = cfg.get(cfg.default_section, 'size')

# We parse the ini configuration and re-use the existing tool
command = ' '.join([args.tool, 'm', args.output, str(size), args.map_file])
print("%s: executing: %s" % (sys.argv[0], command))
wait_rc = os.system(command)
print("%s: wait rc %u" % (sys.argv[0], wait_rc))
if wait_rc >> 8:
    rc = wait_rc >> 8
else:
    rc = wait_rc
sys.exit(rc)
