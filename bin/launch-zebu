#!/bin/bash

set -e

SCRIPT_DIR=$(dirname ${BASH_SOURCE})

function usage()
{
    echo "Usage: $0 [-h] [-e env]* [-m mem]  [ cmd ]" 1>&2
    echo "               cmd: command" 1>&2
    echo "                    run - start emulation (default)" 1>&2
    echo "               -e env: load environment settings from file" 1>&2
    echo "               -m memory map: preload files into memory" 1>&2
    echo "               -h : show this message" 1>&2
    exit 1
}

function preload_memory()
{
    local map_file=$1
    local zebu_mem_file=$2

    while read line
    do
        HASH="#"
        if [[ "$line" =~ ^\s*$ || "$line" =~ ^[[:space:]]*$HASH ]]
        then
            continue
        fi
        line=$(echo $line | sed 's/\(.*\)\s*#.*/\1/')

        mem=$(eval echo $(extract_word 0 $line) )
        # addr=$(eval echo $(extract_word 1 $line) ) # ignored
        file=$(eval echo $(extract_word 2 $line))
        echo $mem $file >> $zebu_mem_file
    done < $map_file
}

source ${SCRIPT_DIR}/launch.sh

: "${RUN_DIR:=.}"
RUN=$(realpath ${RUN_DIR})
mkdir -p "${RUN_DIR}"

# Allow overriding settings (most of which settable via command line)
ENV_FILES=("${PWD}/zebu-env.sh")

MEMORY_FILES=()

while getopts "h?e:m:" o; do
    case "${o}" in
        e)
            ENV_FILES+=("$OPTARG")
            ;;
        m)
            MEMORY_FILES+=("$OPTARG")
            ;;
        h)
            usage
            ;;
        *)
            echo "Wrong option" 1>&2
            usage
            ;;
    esac
done
shift $((OPTIND-1))
CMD=$*

if [ -z "${CMD}" ]
then
    CMD="run"
fi

function source_env()
{
    for env in "${ENV_FILES[@]}"
    do
        source_if_exists "${env}"
    done
}

HPPS_SMC_SRAM_PORTS=4
HPPS_SMC_NAND_PORTS=2

HPPS_SMC_NAND_PORTS_IDXS=$(seq 0 $(($HPPS_SMC_NAND_PORTS - 1)))
HPPS_SMC_SRAM_PORTS_IDXS=$(seq 0 $(($HPPS_SMC_SRAM_PORTS - 1)))

# Initialize defaults (env may override)
#   src_file: file from which to init mem image (none = create blank)
#   run_file: file that will persist the content across runs
#           (note: Zebu requires extension '.raw' for binary format files
#   overwrite: whether to copy from source file on each run
#
# No defaults for size, and for NAND layout params (page, oob, ecc, ppb),
# because those are fixed by HW design loaded into the emulator, so we
# let them be defined by env, so that we don't have to update this script
# itself when the design changes.
for p in $HPPS_SMC_NAND_PORTS_IDXS
do
    declare -A "HPPS_SMC_NAND_${p}=(
        [src_file]=''
        [run_file]='${RUN_DIR}/hpps.nand.${p}.bin.raw'
        [overwrite]=0
    )"
done

for p in $HPPS_SMC_SRAM_PORTS_IDXS
do
    declare -A "HPPS_SMC_SRAM_${p}=(
        [src_file]=''
        [run_file]='${RUN_DIR}/hpps.sram.${p}.bin.raw'
        [overwrite]=0
    )"
done

source_env

for p in $HPPS_SMC_SRAM_PORTS_IDXS
do
    init_smc_sram_img HPPS_SMC_SRAM_${p}
done
for p in $HPPS_SMC_NAND_PORTS_IDXS
do
    init_smc_nand_img HPPS_SMC_NAND_${p}
done

# Must match the name in sdk/zebu/designFeatures
PRELOAD_FILE=$ZEBU/preload.mem
echo -n > "$PRELOAD_FILE"
if [ ${#MEMORY_FILES[@]} -gt 0 ]
then
    for f in "${MEMORY_FILES[@]}"
    do
        preload_memory "$f" "$PRELOAD_FILE"
    done
fi
echo "Zebu mem preload file:"
cat $PRELOAD_FILE

# The Zebu emulator can only be invoked from the SDK dir (would be nice to fix)
#
# The config vars are defined in sdk/bld/env.sh. Can't define then here because
# they are also needed to build zebu part of the SDK, so defined in sdk/Makefile.
$ZEBU_SHELL -c "cd $ZEBU && source $ZEBU_ENV && zRci run_hpsc.ucli" | tee zrci.log
